<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>象棋 (AI建議版)</title>
    <style>
        body { 
            font-family: sans-serif; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            padding: 10px;
            background-color: #f0f0f0;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #info-panel {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 8px 16px;
            border-radius: 5px;
            color: white;
            transition: background-color 0.3s;
        }
        .board-container {
            border: 2px solid black;
        }
        .board-table {
            border-collapse: collapse;
            background-color: #f3dcb6;
        }
        .board-table td {
            width: 38px;
            height: 38px;
            border: 1px solid #a16207;
            text-align: center;
            vertical-align: middle;
            font-size: 26px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
        }
        .river {
            height: 40px;
            font-size: 18px;
            letter-spacing: 0.5em;
            background-color: #eaddc3;
        }
        .piece.red { color: #d90429; }
        .piece.black { color: #1f2937; }

        /* 狀態高亮 */
        .selected { background-color: #fee242; }
        .valid-move { background-color: #a7f3d0; }
        .is-check .piece-span {
            border: 3px solid #dc2626 !important;
            border-radius: 50%;
            display: inline-block;
            width: 36px;
            height: 36px;
            line-height: 36px;
            box-sizing: border-box;
        }
        /* AI 建議高亮 */
        .ai-suggest-from { background-color: #93c5fd; } /* Blue */
        .ai-suggest-to { background-color: #c4b5fd; } /* Purple */

        .action-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        .action-buttons button {
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #4f46e5;
            color: white;
            transition: background-color 0.2s;
        }
        .action-buttons button:hover:not(:disabled) {
            background-color: #4338ca;
        }
        .action-buttons button:disabled {
            background-color: #a5b4fc;
            cursor: not-allowed;
        }
        #ai-info {
            margin-top: 10px;
            padding: 8px;
            min-height: 2.5em;
            text-align: center;
            color: #1e3a8a;
            background-color: #e0e7ff;
            border-radius: 5px;
            width: 90%;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 style="margin: 0; margin-bottom: 10px;">象棋 AI</h1>
        <div id="info-panel"></div>
        <div id="board-container"></div>
        <div class="action-buttons">
            <button id="reset-button">重新開始</button>
            <button id="ai-suggestion-button" disabled>取得AI建議 (黑方)</button>
        </div>
        <div id="ai-info">輪到紅方時，AI按鈕將會停用。</div>
    </div>

<script>
    const boardContainer = document.getElementById('board-container');
    const infoPanel = document.getElementById('info-panel');
    const resetButton = document.getElementById('reset-button');
    const aiSuggestionButton = document.getElementById('ai-suggestion-button');
    const aiInfo = document.getElementById('ai-info');

    // --- Gemini API ---
    const API_KEY = ""; // Canvas 將會自動提供金鑰
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
    
    const PIECES = {
        'k':{name:'將',color:'black'},'g':{name:'士',color:'black'},'e':{name:'象',color:'black'},'h':{name:'馬',color:'black'},'r':{name:'車',color:'black'},'c':{name:'包',color:'black'},'p':{name:'卒',color:'black'},
        'K':{name:'帥',color:'red'},'G':{name:'仕',color:'red'},'E':{name:'相',color:'red'},'H':{name:'馬',color:'red'},'R':{name:'俥',color:'red'},'C':{name:'炮',color:'red'},'P':{name:'兵',color:'red'}
    };
    const initialBoard = [
        ['r','h','e','g','k','g','e','h','r'],[null,null,null,null,null,null,null,null,null],[null,'c',null,null,null,null,null,'c',null],['p',null,'p',null,'p',null,'p',null,'p'],[null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null],['P',null,'P',null,'P',null,'P',null,'P'],[null,'C',null,null,null,null,null,'C',null],[null,null,null,null,null,null,null,null,null],['R','H','E','G','K','G','E','H','R']
    ];

    let board = [];
    let currentPlayer = 'red';
    let selectedPiece = null;
    let validMoves = [];
    let isGameOver = false;
    let aiSuggestion = null;

    function initGame() {
        board = JSON.parse(JSON.stringify(initialBoard));
        currentPlayer = 'red';
        selectedPiece = null;
        validMoves = [];
        isGameOver = false;
        aiSuggestion = null;
        renderBoard();
        updateInfoPanel();
    }

    function renderBoard() {
        let table = document.createElement('table');
        table.className = 'board-table';

        for (let r = 0; r < 10; r++) {
            if (r === 5) {
                let riverRow = table.insertRow();
                let riverCell = riverRow.insertCell();
                riverCell.colSpan = 9;
                riverCell.className = 'river';
                riverCell.innerHTML = '楚 河 漢 界';
            }
            let row = table.insertRow();
            for (let c = 0; c < 9; c++) {
                let cell = row.insertCell();
                cell.dataset.r = r;
                cell.dataset.c = c;
                
                const pieceId = board[r][c];
                if (pieceId) {
                    const pieceInfo = PIECES[pieceId];
                    const pieceSpan = document.createElement('span');
                    pieceSpan.className = 'piece-span';
                    pieceSpan.textContent = pieceInfo.name;
                    cell.className += ` piece ${pieceInfo.color}`;

                    if (pieceId.toLowerCase() === 'k' && isInCheck(pieceInfo.color, board)) {
                        cell.classList.add('is-check');
                    }
                    cell.appendChild(pieceSpan);
                } else {
                    cell.innerHTML = '┼';
                    cell.style.color = '#c9ab81';
                }

                if (selectedPiece && selectedPiece.r === r && selectedPiece.c === c) cell.classList.add('selected');
                if (validMoves.some(move => move[0] === r && move[1] === c)) cell.classList.add('valid-move');
                if (aiSuggestion) {
                    if (aiSuggestion.from[0] === r && aiSuggestion.from[1] === c) cell.classList.add('ai-suggest-from');
                    if (aiSuggestion.to[0] === r && aiSuggestion.to[1] === c) cell.classList.add('ai-suggest-to');
                }
                cell.addEventListener('click', () => onSquareClick(r, c));
            }
        }
        boardContainer.innerHTML = '';
        boardContainer.appendChild(table);
    }

    function onSquareClick(r, c) {
        if (isGameOver) return;
        aiSuggestion = null; // 點擊後清除AI建議高亮

        if (selectedPiece && validMoves.some(move => move[0] === r && move[1] === c)) {
            movePiece(selectedPiece.r, selectedPiece.c, r, c);
            return;
        }
        const pieceId = board[r][c];
        if (pieceId && PIECES[pieceId].color === currentPlayer) {
            selectedPiece = { r, c, id: pieceId, info: PIECES[pieceId] };
            validMoves = getValidMoves(r, c, pieceId, board);
        } else {
            selectedPiece = null;
            validMoves = [];
        }
        renderBoard();
    }

    function movePiece(fromR, fromC, toR, toC) {
        board[toR][toC] = board[fromR][fromC];
        board[fromR][fromC] = null;
        selectedPiece = null;
        validMoves = [];
        currentPlayer = (currentPlayer === 'red') ? 'black' : 'red';
        renderBoard();
        updateInfoPanel();
        checkGameState();
    }

    function updateInfoPanel() {
        const playerText = currentPlayer === 'red' ? '紅方' : '黑方';
        infoPanel.style.backgroundColor = currentPlayer === 'red' ? '#ef4444' : '#1f2937';
        infoPanel.textContent = `輪到 ${playerText} 行棋`;
        if (isInCheck(currentPlayer, board)) {
            infoPanel.textContent += ' (將軍！)';
        }

        if (currentPlayer === 'black' && !isGameOver) {
            aiSuggestionButton.disabled = false;
            aiInfo.textContent = '可以請求 AI 提供黑方建議。';
        } else {
            aiSuggestionButton.disabled = true;
            if (!isGameOver) {
                aiInfo.textContent = '輪到紅方時，AI按鈕將會停用。';
            }
        }
    }
    
    function checkGameState(){if(!hasAnyValidMoves(currentPlayer,board)){isGameOver=!0;const e=currentPlayer==="red"?"black":"red",t=e==="red"?"紅方":"黑方",a=currentPlayer==="red"?"紅方":"黑方",n=isInCheck(currentPlayer,board)?"將死":"困斃",o="將死"===n?`${t}獲勝！ (${n})`:`和棋！ (${a}${n})`;setTimeout(()=>{alert(o),infoPanel.textContent="遊戲結束",aiInfo.textContent="遊戲結束。"},100)}}
    function getValidMoves(r,c,p,b){const t=p.toLowerCase();let m=[];switch(t){case'k':m=getKingMoves(r,c,p,b);break;case'g':m=getGuardMoves(r,c,p,b);break;case'e':m=getElephantMoves(r,c,p,b);break;case'h':m=getHorseMoves(r,c,p,b);break;case'r':m=getRookMoves(r,c,p,b);break;case'c':m=getCannonMoves(r,c,p,b);break;case'p':m=getPawnMoves(r,c,p,b)}return m.filter(v=>{const[R,C]=v;const B=JSON.parse(JSON.stringify(b));B[R][C]=B[r][c];B[r][c]=null;return!isInCheck(PIECES[p].color,B)})}
    function isOwnPiece(r,c,o,b){const p=b[r][c];return p&&PIECES[p].color===o}
    function isOpponentPiece(r,c,o,b){const p=b[r][c];return p&&PIECES[p].color!==o}
    function getKingMoves(r,c,p,b){const m=[],o=PIECES[p].color,a=o==='red'?[[7,3],[9,5]]:[[0,3],[2,5]];[[-1,0],[1,0],[0,-1],[0,1]].forEach(([R,C])=>{const n=r+R,e=c+C;n>=a[0][0]&&n<=a[1][0]&&e>=a[0][1]&&e<=a[1][1]&&!isOwnPiece(n,e,o,b)&&m.push([n,e])});const O=findKing(o==='red'?'black':'red',b);if(O&&O.c===c){let B=!1;for(let i=Math.min(r,O.r)+1;i<Math.max(r,O.r);i++)if(b[i][c]){B=!0;break}B||m.push([O.r,O.c])}return m}
    function getGuardMoves(r,c,p,b){const m=[],o=PIECES[p].color,a=o==='red'?[[7,3],[9,5]]:[[0,3],[2,5]];[[-1,-1],[-1,1],[1,-1],[1,1]].forEach(([R,C])=>{const n=r+R,e=c+C;n>=a[0][0]&&n<=a[1][0]&&e>=a[0][1]&&e<=a[1][1]&&!isOwnPiece(n,e,o,b)&&m.push([n,e])});return m}
    function getElephantMoves(r,c,p,b){const m=[],o=PIECES[p].color,a=o==='red'?4:5;[[-2,-2],[-2,2],[2,-2],[2,2]].forEach(([R,C])=>{const n=r+R,e=c+C,k=r+R/2,i=c+C/2;n>=0&&n<10&&e>=0&&e<9&&((o==='red'&&n>a)||(o==='black'&&n<a))&&!b[k][i]&&!isOwnPiece(n,e,o,b)&&m.push([n,e])});return m}
    function getHorseMoves(r,c,p,b){const m=[],o=PIECES[p].color;[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].forEach(([R,C])=>{const n=r+R,e=c+C,k=r+(Math.abs(R)===2?R/2:0),i=c+(Math.abs(C)===2?C/2:0);n>=0&&n<10&&e>=0&&e<9&&!b[k][i]&&!isOwnPiece(n,e,o,b)&&m.push([n,e])});return m}
    function getRookMoves(r,c,p,b){const m=[],o=PIECES[p].color;[[-1,0],[1,0],[0,-1],[0,1]].forEach(([R,C])=>{for(let i=1;i<10;i++){const n=r+R*i,e=c+C*i;if(n<0||n>9||e<0||e>8)break;if(b[n][e]){isOpponentPiece(n,e,o,b)&&m.push([n,e]);break}m.push([n,e])}});return m}
    function getCannonMoves(r,c,p,b){const m=[],o=PIECES[p].color;[[-1,0],[1,0],[0,-1],[0,1]].forEach(([R,C])=>{let j=!1;for(let i=1;i<10;i++){const n=r+R*i,e=c+C*i;if(n<0||n>9||e<0||e>8)break;if(j){if(b[n][e]){isOpponentPiece(n,e,o,b)&&m.push([n,e]);break}}else if(b[n][e])j=!0;else m.push([n,e])}});return m}
    function getPawnMoves(r,c,p,b){const m=[],o=PIECES[p].color,a=o==='red'?-1:1,k=o==='red'?4:5,n=r+a;n>=0&&n<10&&!isOwnPiece(n,c,o,b)&&m.push([n,c]);if((o==='red'&&r<=k)||(o==='black'&&r>=k))[-1,1].forEach(C=>{const e=c+C;e>=0&&e<9&&!isOwnPiece(r,e,o,b)&&m.push([r,e])});return m}
    function findKing(o,b){const p=o==='red'?'K':'k';for(let r=0;r<10;r++)for(let c=0;c<9;c++)if(b[r][c]===p)return{r,c};return null}
    function isInCheck(o,b){const a=findKing(o,b);if(!a)return!0;const k=o==='red'?'black':'red';for(let r=0;r<10;r++)for(let c=0;c<9;c++){const p=b[r][c];if(p&&PIECES[p].color===k){const m=getRawValidMoves(r,c,p,b);if(m.some(v=>v[0]===a.r&&v[1]===a.c))return!0}}return!1}
    function getRawValidMoves(r,c,p,b){const t=p.toLowerCase();switch(t){case'k':return getKingMoves(r,c,p,b);case'g':return getGuardMoves(r,c,p,b);case'e':return getElephantMoves(r,c,p,b);case'h':return getHorseMoves(r,c,p,b);case'r':return getRookMoves(r,c,p,b);case'c':return getCannonMoves(r,c,p,b);case'p':return getPawnMoves(r,c,p,b)}return[]}
    function hasAnyValidMoves(o,b){for(let r=0;r<10;r++)for(let c=0;c<9;c++){const p=b[r][c];if(p&&PIECES[p].color===o&&getValidMoves(r,c,p,b).length>0)return!0}return!1}
    
    // --- AI 功能 ---
    function formatBoardForAI(boardState) {
        let boardString = "  0 1 2 3 4 5 6 7 8 (c)\n";
        boardState.forEach((row, r) => {
            boardString += `${r} ` + row.map(p => p === null ? '.' : p).join(' ') + '\n';
        });
        return boardString;
    }

    async function getAISuggestion() {
        if (currentPlayer !== 'black' || isGameOver) return;

        aiSuggestionButton.disabled = true;
        aiInfo.textContent = 'AI 思考中，請稍候...';
        aiSuggestion = null;
        renderBoard(); // 清除舊的高亮

        const formattedBoard = formatBoardForAI(board);
        const systemPrompt = "你是一位象棋大師。請根據目前的棋盤狀態，為黑方建議最好的一步棋。";
        const userQuery = `這是目前的棋盤狀態 (r=車, h=馬, e=象, g=士, k=將, c=炮, p=卒; R=俥, H=傌, E=相, G=仕, K=帥, C=炮, P=兵; '.' 代表空格):\n\n${formattedBoard}\n現在輪到黑方 (black) 行棋。\n\n請分析盤面後，找出對黑方最有利的一步，並只用指定的 JSON 格式回覆。`;
        
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        "from": { "type": "ARRAY", "items": { "type": "NUMBER" } },
                        "to": { "type": "ARRAY", "items": { "type": "NUMBER" } },
                        "reason": { "type": "STRING" }
                    },
                    required: ["from", "to", "reason"]
                }
            }
        };

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API 請求失敗，狀態碼: ${response.status}`);
            }

            const result = await response.json();
            const text = result.candidates[0].content.parts[0].text;
            const suggestion = JSON.parse(text);

            // 驗證AI的回應是否合法
            const [fromR, fromC] = suggestion.from;
            const [toR, toC] = suggestion.to;
            const pieceId = board[fromR][fromC];

            if (pieceId && PIECES[pieceId].color === 'black') {
                const legalMoves = getValidMoves(fromR, fromC, pieceId, board);
                if (legalMoves.some(move => move[0] === toR && move[1] === toC)) {
                    aiSuggestion = { from: [fromR, fromC], to: [toR, toC] };
                    aiInfo.textContent = `AI 建議: ${suggestion.reason}`;
                    renderBoard();
                } else {
                    throw new Error('AI 建議了一個不合法的走法。');
                }
            } else {
                throw new Error('AI 建議移動一個不存在或不屬於黑方的棋子。');
            }

        } catch (error) {
            console.error("AI 建議出錯:", error);
            aiInfo.textContent = '無法取得AI建議，請稍後再試。';
        } finally {
            if (!isGameOver) {
                aiSuggestionButton.disabled = false;
            }
        }
    }

    resetButton.addEventListener('click', initGame);
    aiSuggestionButton.addEventListener('click', getAISuggestion);
    initGame();
</script>

</body>
</html>
